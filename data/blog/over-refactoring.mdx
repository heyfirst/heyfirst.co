---
title: "Over-Refactoring: อย่าให้พวก Best Practice ทำให้เราทำงานยากขึ้น"
publishedAt: "2021-06-22"
summary: "หลายคนคงเคยเจอเหตุการณ์ที่เรา Refactor โค้ดแล้วมันกลับมาทำร้ายเราทีหลังกันบ้างไหมครับ วันนี้ผมอยากชวนทุกคนมาตั้งคำถามและหาทางแก้ไปด้วยกัน อย่าให้พวก Best Practice ทำให้เราทำงานยากขึ้น"
image: "/static/blog/over-refactoring/anthony-fomin-sTw2KYpoujk-unsplash.jpg"
---

ปกติเวลา[เราเขียนโค้ดหรือเขียนโปรแกรม](/blog/make-it-work-make-it-right-make-it-fast) เราทุกคนมักจะมักจะต้องเคย Refactor กันมาบ้างอยู่แล้วใช่ไหมครับ เพื่อทำให้โค้ดเราดีขึ้น สะอาดขึ้น ง่ายต่อการต่อยอด (Extendable) หรือง่ายต่อการนำไปใช้ต่อ (Reusable) หรือมี Performance ที่ดีขึ้นเป็นต้น

หลายคนคงเคยเจอเหตุการณ์ที่เรา Refactor โค้ดแล้วมันกลับมาทำร้ายเราทีหลังกันบ้างไหมครับ

เช่น เราจะทำ A เขียนเทสและ Refactor ด้วยทุกเทคนิคที่เรามีทั้งหมด แต่วันนึงพอเราต้องเพิ่ม Feature ใหม่เข้าไปใน A แล้วเราเหมือนพบฝันร้ายเพราะโค้ด A ไม่อำนวยให้เราเพิ่ม Feature เข้าไป อาจจะต้องรื้อเขียนใหม่..

รอบตัวผมเกิดปัญหานี้บ่อยครับ ส่วนตัวผมเองมักจะเรียกมันว่า **"Over Refactoring"**

วันนี้เรามาหาคำตอบกันว่ามันเกิดขึ้นเพราะอะไรได้บ้าง แล้วจะแก้ปัญหานี้ยังไงดี

<Image
  alt={`Construction Site`}
  src={`/static/blog/over-refactoring/anthony-fomin-sTw2KYpoujk-unsplash.jpg`}
  height={4000}
  width={6000}
  priority
/>

## Code Smells, Design Patterns, Refactoring Techniques และเหล่า Software Principle ทั้งหลาย

ผมขอเล่าจากประสบการณ์ของตัวเอง สมัยที่เรียนจบและเข้าทำงาน ๆ

ทำให้ผมเป็นคนที่ชอบศึกษาพวก Best Practice ต่าง ๆ เช่น Code smell, Design Patterns, Refactoring Techniques หรือพวก Software Principle ต่าง ๆ เช่น SOLID, KISS, DRY, YAGNI และอื่น ๆ มากมาย

พอเวลาเราเห็นโค้ดที่คนอื่นเขียนแล้วไม่ตรงตามสิ่งเหล่านี้ เรามักจะบอกว่า "เขียนแบบนี้สิ มันจะได้ทำสิ่งนี้ได้!" "ทำไมไม่ตาม principle ล่ะ!" "นั่นไง โค้ดมันมี Smell เดี่ยวมันจะแย่นะ"

จนถึงวันหนึ่งที่ผมพยายามเขียนโค้ดให้มันถูกต้องตามหลักมากที่สุดอยู่นั้น และต้องเพิ่ม Feature ใหม่เข้าไป มันกับกลายเป็นว่าผมต้องรื้อโค้ดทิ้งกว่า 500 บรรทัด เพื่อรื้อโค้ด Architecture ของ Feature นั้นใหม่ทั้งหมด

แม้จะมี Testcase ครอบคลุมก็ช่วยอะไรไม่ได้มากนัก เพราะมันไม่ได้พัง แค่มันต่อเติมไม่ได้เท่านั้นเอง

มันจึงมีคำถามเกิดขึ้นว่า.. เอาจริง ๆ โค้ดก่อนที่จะ Refactor นั้นมันแย่จริง ๆ หรอ? แล้วถ้าทำตาม Software Principle มันทำให้ดีขึ้นจริงหรือเปล่า?

เพราะเวลาที่ทุกคน (รวมถึง Blog ต่าง ๆ) เล่าถึง Software Principle และเทคนิคเหล่านี้ พวกเขามักพูดแค่ว่า เทคนิคเหล่านี้ช่วยแก้ปัญหาอย่างไร แต่ไม่ค่อยได้บอกว่าเทคนิคเหล่านี้สร้างปัญหาอะไร

เหรียญมีสองด้านเสมอ เพราะทุกการ Refactoring นั้นนำพา trade-offs ใหม่ ๆ เสมอ ก่อนจะหยิบนำมาใช้ พวกเราเข้าใจมันมากพอแล้วหรือยัง

## ทำไมเรา Refactor นะ?

ก่อนจะหยิบโค้ดซักชุดมาแก้ ผมมักจะถามตัวเองก่อนว่า "ทำไมเรา Refactor นะ?"

หากเราเข้าใจแล้วว่าเป้าหมายคืออะไร ค่อยหยิบจับเอา Design Pattern, Refactoring Technique หรือ Software Principle มาแก้ปัญหา รวมถึงทำความเข้าใจ Trade-offs ของเทคนิคต่าง ๆ ที่เราหยิบนำมาใช้ด้วย

ไม่ใช่เพียงแค่นั้น สิ่งหนึ่งที่สำคัญคือเข้าใจ Business Context ด้วย เช่นเรื่องของ Requirement ที่อยู่ใน Backlog ว่าต่อไปจะต้องต่อเติมไปทางไหน, ทักษะของคนในทีมว่าถ้าใช้วิธีนี้เขาจะเข้าใจและนำไปทำต่อได้หรือเปล่า

หากเข้าใจทั้ง Technical และ Business Context แล้ว จะทำให้เรารู้ตัวว่า "เราต้องการอะไร" "เราต้องทำเพียงแค่ไหน" รวมถึงรู้ตัวว่า "เรากำลังจะ Over-Refactoring หรือเปล่า"

ถ้าเรา Refactor แล้ว มันทำให้งานเรายากขึ้น แสดงว่าเรากำลังมาผิดทาง..

## Rule of Three

เทคนิคหนึ่งที่ผมแนะนำเบื้องต้นได้ คือ การไม่ Refactor บ่อยเกินไป .. การใช้ [Rule of Three](/blog/1-2-refactor) หรือ **กฏนับสาม** เข้ามาช่วยจะทำให้เราไม่หลงกับการ Refactor ที่ไม่จำเป็น

กฏมันก็ง่าย ๆ แค่ว่า จะยังไม่ Refactor จนกว่าจะมีโค้ดที่ดูแย่ 3 จุดซ้ำกันในพื้นที่ที่เรากำลังทำงานอยู่นั่นเองครับ

ผมเชื่อว่าโปรแกรมเมอร์หลายคนมีนิสัยจับจนและอยากจะขัดเกลาโค้ดของตัวเองให้สวยงานที่สุดตลอดเวลา

อย่ายอมให้มันกลับมาทำร้ายเรานะครับ อย่างน้อยที่สุดใช้กฏนับสามนี้มาช่วยห้ามเรา จะทำให้เราพบเจอกับสถาณการณ์ Over-Refactoring น้อยลงอย่างแน่นอน

## สรุปสุดท้าย

ผมไม่ได้กล่าวร้ายและบอกว่าเทคนิคต่าง ๆ นั้นไม่ดีหรือไม่ควรใช้ แต่อยากให้มองลึกลงไปว่าทุกครั้งที่เรานำเทคนิคเหล่านั้นมา Refactor โค้ดของเรา มันจะมีผลอะไรเกิดได้ขึ้นบ้าง เรารับรู้ถึง trade-offs เหล่านั้นหรือเปล่า ไม่ใช่เพียงแน่หยิบนำมาใช้ตามคนอื่นบอกเล่ามาว่ามันต้องเป็นแบบนั้นหรือแบบนี้
เหมือนกับที่ผมเคยเล่าไว้ในบทความ ["Best Practice" (อาจจะ)ไม่มีจริง](/blog/best-practice-might-be-wrong)

ถ้าบทความที่ผมเขียนทำให้ทุกคนที่อ่านเริ่มตระหนักถึง Trade-offs ของเทคนิคและวิธีการ อย่าง Code Smell กับ Refactoring, แนวคิดต่าง ๆ ใน Software Principle รวมถึงการเลือกหยิบจับเทคโนโลยีมาใช้งานได้ สำหรับผมก็ถือว่าประสบความสำเร็จแล้วล่ะครับ

ถึงเวลาถามกลับทุกคนบ้าง .. วันนี้ทุกคนกำลังเผลอ Over Refactoring อยู่หรือเปล่าครับ?
