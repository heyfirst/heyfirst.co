---
title: "Over-Refactoring: อย่าให้พวก Best Practice ทำให้เราทำงานยากขึ้น"
publishedAt: "2021-06-22"
summary: "หลายคนคงเคยเจอเหตุการณ์ที่เรา Refactor โค้ดแล้วมันกลับมาทำร้ายเราทีหลังกันบ้างไหมครับ วันนี้ผมอยากชวนทุกคนมาตั้งคำถามและหาทางแก้ไปด้วยกัน อย่าให้พวก Best Practice ทำให้เราทำงานยากขึ้น"
image: "/static/blog/over-refactoring/anthony-fomin-sTw2KYpoujk-unsplash.jpg"
---

ปกติเวลา[เราเขียนโปรแกรม](/blog/make-it-work-make-it-right-make-it-fast) เราทุกคนมักต้องเคย Refactor กันมาบ้างอยู่แล้วใช่ไหมครับ เพื่อทำให้โค้ดเราดีขึ้น สะอาดขึ้น ง่ายต่อการต่อยอด (Extendable) ง่ายต่อการนำไปใช้ต่อ (Reusable) หรือ Performance ที่ดีขึ้น เป็นต้น

แล้วมีใครเคยพบเจอเหตุการณ์ที่ Refactor แล้ว แต่โค้ดกลับมาทำร้ายเราทีหลังไหมครับ?

เช่น เราทำ A เราเขียนเทสและ Refactor ด้วยทุกเทคนิคที่เรามีทั้งหมด แต่วันนึงพอเราต้องเพิ่ม Feature ใหม่เข้าไปใน A แล้ว เราเหมือนพบฝันร้ายเพราะโค้ด A ไม่อำนวยให้เราเพิ่ม Feature เข้าไป .. และอาจจะต้องรื้อเขียนใหม่

รอบตัวผมเกิดปัญหานี้บ่อยครับ ส่วนตัวผมเองมักจะเรียกมันว่า **"Over Refactoring"**

วันนี้เรามาหาคำตอบกันว่ามันเกิดขึ้นเพราะอะไรได้บ้าง แล้วเราจะแก้ปัญหานี้ยังไงดี

<Image
  alt={`Construction Site`}
  src={`/static/blog/over-refactoring/anthony-fomin-sTw2KYpoujk-unsplash.jpg`}
  height={4000}
  width={6000}
  priority
/>

## Code Smells, Design Patterns, Refactoring Techniques และเหล่า Software Principle ทั้งหลาย

ผมขอเล่าจากประสบการณ์ของตัวเอง สมัยที่เรียนจบและเข้าทำงานช่วงแรก ๆ

ผมชอบศึกษาพวก Best Practice ต่าง ๆ เช่น Code smells, Design Patterns, Refactoring Techniques หรือพวก Software Principle ต่าง ๆ เช่น SOLID, KISS, DRY, YAGNI, ฯลฯ

พอเวลาเราเห็นโค้ดที่คนอื่นเขียนแล้วไม่ตรงตามสิ่งเหล่านี้ เรามักจะบอกว่า "เขียนแบบนี้สิ มันจะได้ทำสิ่งนี้ได้!" "ทำไมไม่ตาม Software Principle ล่ะ!" "นั่นไง โค้ดมันมี Smell เดี๋ยวมันจะแย่ทีหลังนะ"

จนกระทั่งวันนึงที่ผมพยายามเขียนโค้ดให้มันถูกต้องตามหลักมากที่สุดอยู่ และต้องเพิ่ม Feature ใหม่เข้าไป มันกลับกลายเป็นว่าผมต้องรื้อโค้ดทิ้งกว่า 500 บรรทัด เพื่อรื้อ Architecture ของ Feature นั้นใหม่ทั้งหมด

แม้จะเขียน Test ไปเยอะมากแค่ไหนมันก็ไม่ได้ช่วย เพราะมันพังจากการออกแบบที่ไม่ดีนั่นเอง

มันจึงมีคำถามเกิดขึ้นว่า.. โค้ดก่อนที่จะ Refactor นั้นมันแย่จริง ๆ หรอ? แล้วถ้าทำตาม Software Principle มันทำให้ดีขึ้นจริงหรือเปล่า?

เพราะเวลาที่ทุกคน (รวมถึงบทความต่าง ๆ) เล่าถึง Software Principle และเทคนิคเหล่านี้ พวกเขามักพูดแค่ว่า **เทคนิคเหล่านี้ช่วยแก้ปัญหาอย่างไร แต่ไม่ค่อยได้บอกว่าเทคนิคเหล่านี้นำพาข้อจำกัดอะไรเข้ามาบ้าง**

เหรียญมันมีสองด้าน เพราะทุกการ Refactor นั้นนำพา trade-offs ใหม่ ๆ มาเสมอ ก่อนจะหยิบนำมาใช้ พวกเราเข้าใจมันมากพอแล้วหรือยัง

## ทำไมเรา Refactor นะ?

ก่อนจะหยิบโค้ดซักชุดมาแก้ไข ผมมักจะถามตัวเองก่อนว่า "ทำไมเรา Refactor นะ?"

หากเราเข้าใจแล้วว่าเป้าหมายคืออะไร ค่อยหยิบจับเอา Design Pattern, Refactoring Technique หรือ Software Principle มาแก้ปัญหา รวมถึงทำความเข้าใจ Trade-offs ของเทคนิคต่าง ๆ ที่เราหยิบนำมาใช้ด้วย

ไม่ใช่เพียงแค่นั้น สิ่งหนึ่งที่สำคัญคือเข้าใจ Business Context ด้วย เช่น Requirements ที่อยู่ใน Backlog ว่าต่อไปจะต้องต่อเติมอะไรไปทางไหน, ทักษะของคนในทีมว่าถ้าใช้วิธีนี้จะสามารถเข้าใจและนำไปทำต่อได้หรือไม่

ทั้งหมดจะทำให้เรารู้ตัวว่า "เราต้องการอะไร" "เราต้องทำเพียงแค่ไหน" รวมถึงรู้ตัวว่า "เรากำลังจะ Over-Refactoring หรือเปล่า"

ิ**เพราะถ้าเรา Refactor แล้ว มันทำให้งานเรายากขึ้น แสดงว่าเรากำลังมาผิดทาง..**

## Rule of Three

เทคนิคหนึ่งที่ผมแนะนำเบื้องต้นได้ คือ การไม่ Refactor บ่อยเกินไป .. การใช้ [Rule of Three](/blog/1-2-refactor) หรือ **กฎนับสาม** เข้ามาช่วยจะทำให้เราไม่หลงกับการ Refactor ที่ไม่จำเป็น

กฏมันก็ง่าย ๆ แค่ว่า จะยังไม่ Refactor จนกว่าจะมีโค้ดที่ดูแย่ 3 จุดซ้ำกันในพื้นที่ที่เรากำลังทำงานอยู่นั่นเองครับ

ผมเชื่อว่าโปรแกรมเมอร์หลายคนมีนิสัยจับจดและอยากจะขัดเกลาโค้ดของตัวเองให้สวยงานที่สุดตลอดเวลา

อย่ายอมให้มันกลับมาทำร้ายเรานะครับ อย่างน้อยที่สุดใช้กฎนับสามนี้มาช่วยห้ามเรา จะทำให้เราพบเจอกับสถานการณ์ Over-Refactoring น้อยลงอย่างแน่นอน

## สรุปสุดท้าย

ผมไม่ได้กล่าวร้ายและบอกว่าเทคนิคต่าง ๆ นั้นแย่หรือไม่ควรใช้ แต่อยากให้มองลึกลงไปว่าทุกครั้งที่เรานำเทคนิคเหล่านั้นมา Refactor โค้ดของเรา มันจะมีผลอะไรเกิดได้ขึ้นบ้าง เรารับรู้ถึง trade-offs เหล่านั้นหรือเปล่า ไม่ใช่เพียงแค่หยิบนำมาใช้ตามคนอื่นบอกเล่ามาว่ามันต้องเป็นแบบนั้นหรือแบบนี้
เหมือนกับที่ผมเคยเล่าไว้ในบทความ ["Best Practice" (อาจจะ)ไม่มีจริง](/blog/best-practice-might-be-wrong)

ถ้าบทความที่ผมเขียนทำให้ทุกคนที่อ่านเริ่มตระหนักถึง Trade-offs ของเทคนิคและวิธีการ อย่าง Code Smell กับ Refactoring, แนวคิดต่าง ๆ ใน Software Principle รวมถึงการเลือกหยิบจับเทคโนโลยีมาใช้งานได้ สำหรับผมก็ถือว่าประสบความสำเร็จแล้วล่ะครับ

ถึงเวลาถามกลับทุกคนบ้าง .. วันนี้ทุกคนกำลังเผลอ Over Refactoring อยู่หรือเปล่าครับ?
